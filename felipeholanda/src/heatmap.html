<!-- Code from d3-graph-gallery.com -->
<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>

<!-- Create a div where the graph will take place -->
<div id="main2"></div>

<script>

// set the dimensions and margins of the graph
var margin = {top: 80, right: 25, bottom: 30, left: 40};
  
var width = 450 - margin.left - margin.right;
var height = 450 - margin.top - margin.bottom;

// append the svg object to the body of the page
var svg = d3.select("#main2")
.append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
.append("g")
  .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");

//Read the data
d3.csv("../../data/data.csv", function(loadedData) {

  function filterAndParametrizeHeatmapData(heatmapData) {

    let newHeatmapData = []

    heatmapData.forEach(element => {
      if (element.qtd_acidentes <= 300){
        if (element.qtd_acidentes >= 0 && element.qtd_acidentes < 20) {
          newHeatmapData.push({ veiculos: element.veiculos, km: element.km, qtd_acidentes: 1, parametrized_text: '0 a 20 acidentes' })
        } else if (element.qtd_acidentes >= 20 && element.qtd_acidentes < 40) {
          newHeatmapData.push({ veiculos: element.veiculos, km: element.km, qtd_acidentes: 2, parametrized_text: '20 a 40 acidentes' })
        } else if (element.qtd_acidentes >= 40 && element.qtd_acidentes < 60) {
          newHeatmapData.push({ veiculos: element.veiculos, km: element.km, qtd_acidentes: 3, parametrized_text: '40 a 60 acidentes' })
        } else if (element.qtd_acidentes >= 60 && element.qtd_acidentes < 80) {
          newHeatmapData.push({ veiculos: element.veiculos, km: element.km, qtd_acidentes: 4, parametrized_text: '60 a 80 acidentes' })
        } else if (element.qtd_acidentes >= 80 && element.qtd_acidentes < 100) {
          newHeatmapData.push({ veiculos: element.veiculos, km: element.km, qtd_acidentes: 5, parametrized_text: '80 a 100 acidentes' })
        } else if (element.qtd_acidentes >= 100 && element.qtd_acidentes < 120) {
          newHeatmapData.push({ veiculos: element.veiculos, km: element.km, qtd_acidentes: 6, parametrized_text: '100 a 120 acidentes' })
        } else if (element.qtd_acidentes >= 120 && element.qtd_acidentes < 140) {
          newHeatmapData.push({ veiculos: element.veiculos, km: element.km, qtd_acidentes: 7, parametrized_text: '120 a 140 acidentes' })
        } else if (element.qtd_acidentes >= 140 && element.qtd_acidentes < 160) {
          newHeatmapData.push({ veiculos: element.veiculos, km: element.km, qtd_acidentes: 8, parametrized_text: '140 a 160 acidentes' })
        } else if (element.qtd_acidentes >= 160 && element.qtd_acidentes < 180) {
          newHeatmapData.push({ veiculos: element.veiculos, km: element.km, qtd_acidentes: 9, parametrized_text: '160 a 180 acidentes' })
        } else if (element.qtd_acidentes >= 180 && element.qtd_acidentes < 200) {
          newHeatmapData.push({ veiculos: element.veiculos, km: element.km, qtd_acidentes: 10, parametrized_text: '180 a 200 acidentes' })
        } else if (element.qtd_acidentes >= 200 && element.qtd_acidentes < 220) {
          newHeatmapData.push({ veiculos: element.veiculos, km: element.km, qtd_acidentes: 11, parametrized_text: '200 a 220 acidentes' })
        } else if (element.qtd_acidentes >= 220 && element.qtd_acidentes < 240) {
          newHeatmapData.push({ veiculos: element.veiculos, km: element.km, qtd_acidentes: 12, parametrized_text: '220 a 240 acidentes' })
        } else if (element.qtd_acidentes >= 240 && element.qtd_acidentes < 260) {
          newHeatmapData.push({ veiculos: element.veiculos, km: element.km, qtd_acidentes: 13, parametrized_text: '240 a 260 acidentes' })
        } else if (element.qtd_acidentes >= 2600 && element.qtd_acidentes < 280) {
          newHeatmapData.push({ veiculos: element.veiculos, km: element.km, qtd_acidentes: 14, parametrized_text: '2600 a 280 acidentes' })
        } else {
          newHeatmapData.push({ veiculos: element.veiculos, km: element.km, qtd_acidentes: 15, parametrized_text: '280 a 300 acidentes' })
        }
      }
    });

    return newHeatmapData;

  }

  function groupByKmAndVehicle() {
    let heatmapData = [];

    loadedData.reduce(function(res, value) {
     
      value.km = Math.round(+value.km - 321);

      if (!res[value.km + "-" + value.veiculos]) {
        res[value.km + "-" + value.veiculos] = { veiculos: value.veiculos, km: value.km, qtd_acidentes: 0 };
        heatmapData.push(res[value.km + "-" + value.veiculos])
      }
      
      res[value.km + "-" + value.veiculos].qtd_acidentes = res[value.km + "-" + value.veiculos].qtd_acidentes + 1;
    
      return res;
    }, {});
    
    return filterAndParametrizeHeatmapData(heatmapData);
  }

  let data = groupByKmAndVehicle();

  console.log(data)

  // Labels of row and columns -> unique identifier of the column called 'group' and 'variable'
  var tempMyGroups = d3.map(data, function(d){return d.veiculos;}).keys()
  var tempMyVars = d3.map(data, function(d){return d.km;}).keys()

  let myGroups = [];
  let myVars = [];

  tempMyGroups.forEach(element => {
    myGroups.push(parseInt(element))
  });

  tempMyVars.forEach(element => {
    myVars.push(parseInt(element))
  });

  myVars.sort(function(a, b) {
    return a - b;
  });

  myGroups.sort(function(a, b) {
    return a - b;
  });

  // Build X scales and axis:
  var x = d3.scaleBand()
    .range([ 0, width ])
    .domain(myGroups)
    .padding(0.05);
  svg.append("g")
    .style("font-size", 15)
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x).tickSize(0))
    .select(".domain").remove()

  // Build Y scales and axis:
  var y = d3.scaleBand()
    .range([ height, 0 ])
    .domain(myVars)
    .padding(0.05);
  svg.append("g")
    .style("font-size", 15)
    .call(d3.axisLeft(y).tickSize(0))
    .select(".domain").remove()

  // Build color scale
  var myColor = d3.scaleSequential()
    .interpolator(d3.interpolateInferno)
    .domain([1,15])

  // create a tooltip
  var tooltip = d3.select("#main2")
    .append("div")
    .style("opacity", 0)
    .attr("class", "tooltip")
    .style("background-color", "white")
    .style("border", "solid")
    .style("border-width", "2px")
    .style("border-radius", "5px")
    .style("padding", "5px")

  // Three function that change the tooltip when user hover / move / leave a cell
  var mouseover = function(d) {
    tooltip
      .style("opacity", 1)
    d3.select(this)
      .style("stroke", "black")
      .style("opacity", 1)
  }
  var mousemove = function(d) {
    tooltip
      .html("The exact value of<br>this cell is: " + d.parametrized_text)
      .style("left", (d3.mouse(this)[0]+70) + "px")
      .style("top", (d3.mouse(this)[1]) + "px")
  }
  var mouseleave = function(d) {
    tooltip
      .style("opacity", 0)
    d3.select(this)
      .style("stroke", "none")
      .style("opacity", 0.8)
  }

  // add the squares
  svg.selectAll()
    .data(data, function(d) {return d.veiculos+':'+d.km;})
    .enter()
    .append("rect")
      .attr("x", function(d) { return x(d.veiculos) })
      .attr("y", function(d) { return y(d.km) })
      .attr("rx", 4)
      .attr("ry", 4)
      .attr("width", x.bandwidth() )
      .attr("height", y.bandwidth() )
      .style("fill", function(d) { return myColor(d.qtd_acidentes)} )
      .style("stroke-width", 4)
      .style("stroke", "none")
      .style("opacity", 0.8)
    .on("mouseover", mouseover)
    .on("mousemove", mousemove)
    .on("mouseleave", mouseleave)
})

/*

// Add title to graph
svg.append("text")
        .attr("x", 0)
        .attr("y", -50)
        .attr("text-anchor", "left")
        .style("font-size", "22px")
        .text("A d3.js heatmap");

// Add subtitle to graph
svg.append("text")
        .attr("x", 0)
        .attr("y", -20)
        .attr("text-anchor", "left")
        .style("font-size", "14px")
        .style("fill", "grey")
        .style("max-width", 400)
        .text("A short description of the take-away message of this chart.");
*/

</script>